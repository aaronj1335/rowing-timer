#!/bin/bash -ex

if [ $TRAVIS_PULL_REQUEST != false ] || [ $TRAVIS_BRANCH != master ]; then
  echo not deploying since this isn\'t the master branch
  exit
fi

if ! [ -e build ]; then
  echo build directory does not exist >&2
  exit 2
fi

echo deploying

hash=`git rev-parse --short HEAD`

git fetch origin gh-pages
git checkout FETCH_HEAD
cp -r build/* ./
rm -rf build

if ! git diff 2>&1 1>/dev/null; then
  echo no changes, exiting
  exit
fi

git add .
git commit -am "deploying master@$hash"

# if we're in a travis build, decrypt and use the deploy key (otherwise just
# rely on some existing authentication)
if [ $TRAVIS ]; then
  openssl aes-256-cbc \
    -K $encrypted_a85afbccab54_key \
    -iv $encrypted_a85afbccab54_iv \
    -in rowing-timer-deploy.enc \
    -out rowing-timer-deploy \
    -d
  chmod 600 rowing-timer-deploy
  eval `ssh-agent -s`
  ssh-add rowing-timer-deploy
fi

git remote -v
git push origin gh-pages

# reset to master
if ! [ $CI ]; then
  git checkout master
fi
